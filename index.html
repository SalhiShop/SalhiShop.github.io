<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Salhi Shop</title>

  <!-- Firebase compat CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Styles inline -->
  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f0f7fa;color:#03363a}
    .header{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:#00bcd4;color:white;box-shadow:0 2px 6px rgba(0,0,0,0.12)}
    .header h1{margin:0;font-size:1.4rem}
    .user-area{display:flex;align-items:center;gap:14px}
    .user-info{display:flex;flex-direction:column;align-items:flex-end;line-height:1}
    .btn{background:white;color:#00bcd4;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,0.12)}
    .secondary{display:flex;align-items:center;padding:10px 12px;background:#00acc1;color:white;font-weight:700;position:relative}
    .secondary .left, .secondary .center, .secondary .right{display:flex;align-items:center}
    .secondary .center { margin: 0 auto; gap:24px; }
    .secondary a{color:white;text-decoration:none;padding:6px 12px;border-radius:8px}
    .secondary a:hover{background:rgba(255,255,255,0.08)}
    main{display:flex;justify-content:center;align-items:center;min-height:calc(100vh - 140px);padding:20px;text-align:center}
    .card{background:white;padding:28px;border-radius:12px;box-shadow:0 12px 30px rgba(2,50,50,0.06);max-width:780px;width:100%}
    .title{color:#00bcd4;margin:0 0 8px 0;font-size:1.8rem}
    .action{background:#00bcd4;color:white;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-weight:700}
    .action:hover{background:#0097a7}
    @media (max-width:640px){ .secondary .center { gap:12px } .header h1{font-size:1.1rem} }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <h1>Salhi Shop</h1>
    <div class="user-area">
      <div class="user-info">
        <div id="pseudoWrap" style="display:none;font-weight:700;background:rgba(255,255,255,0.08);padding:6px 10px;border-radius:999px;font-size:0.95rem;color:white"></div>
        <div id="emailWrap" style="display:none;font-size:0.80rem;color:rgba(255,255,255,0.95);margin-top:4px"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="loginBtn" class="btn" onclick="window.location.href='login.html'">Se connecter</button>
        <button id="logoutBtn" class="btn" style="display:none;">Se déconnecter</button>
      </div>
    </div>
  </header>

  <!-- Barre secondaire : left (admin placeholder), center (les 3 boutons centrés), right (vide) -->
  <div class="secondary" id="secondaryNav">
    <div class="left" id="adminLeft" style="margin-left:12px;">
      <!-- Admin button will be injected here -->
    </div>

    <div class="center" id="centerLinks">
      <a href="index.html">Accueil</a>
      <a href="#commandes">Commande</a>
      <a href="info.html">Info</a>
    </div>

    <div class="right" style="width:120px;"></div>
  </div>

  <!-- Contenu -->
  <main>
    <div class="card">
      <h2 class="title">Bienvenue sur Salhi Shop !</h2>
      <p style="margin:0 0 16px 0;color:#275a5b">Découvrez nos produits et promotions.</p>

      <section id="commandes">
        <h3 style="margin:0 0 8px 0">Passer une commande</h3>
        <button class="action" id="orderBtn">Commander</button>
      </section>

      <section id="info" style="margin-top:18px;color:#567;font-size:0.95rem">
        <p>Infos : adresse du magasin, horaires, contact…</p>
      </section>
    </div>
  </main>

  <!-- Script: Firebase compat + logique admin button -->
  <script>
    // config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyByfz30HgKDfynhOXb24hSOReTJOfk77mI",
      authDomain: "salhishop-1.firebaseapp.com",
      projectId: "salhishop-1",
      storageBucket: "salhishop-1.firebasestorage.app",
      messagingSenderId: "784629559774",
      appId: "1:784629559774:web:388f9ca4c33e90d6fcad4f",
      measurementId: "G-34G9453E7H"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const pseudoWrap = document.getElementById('pseudoWrap');
    const emailWrap = document.getElementById('emailWrap');
    const adminLeft = document.getElementById('adminLeft');
    const orderBtn = document.getElementById('orderBtn');

    // logout
    window.logout = async function(){
      try{
        await auth.signOut();
        alert('Déconnecté avec succès !');
      }catch(e){ alert('Erreur : '+e.message) }
    };
    logoutBtn.addEventListener('click', window.logout);

    // commande
    window.passerCommande = function(){
      const user = auth.currentUser;
      if(!user || !user.emailVerified){ alert('Vous devez être connecté et avoir vérifié votre email pour passer une commande.'); return; }
      alert('Commande (fonctionnalité à implémenter).');
    };
    orderBtn.addEventListener('click', () => window.passerCommande());

    // crée admin doc initial si n'existe pas ET si user est kenzo0025@outlook.fr
    async function ensureInitialAdminsDoc(userEmail){
      try{
        const ref = db.collection('meta').doc('admins');
        const snap = await ref.get();
        if(!snap.exists){
          const low = (userEmail||'').toLowerCase();
          if(low === 'kenzo0025@outlook.fr'){
            await ref.set({ emails: [low] }, { merge: true });
            console.log('meta/admins créé avec', low);
            return [low];
          }
          return [];
        } else {
          return snap.data().emails || [];
        }
      }catch(e){
        console.warn('ensureInitialAdminsDoc err', e);
        return [];
      }
    }

    // affiche le bouton Admin (simple link)
    function showAdminButton(){
      adminLeft.innerHTML = '<a href="admin.html" style="background:white;color:#00bcd4;padding:6px 10px;border-radius:6px;text-decoration:none;font-weight:700">Admin</a>';
    }
    function hideAdminButton(){ adminLeft.innerHTML = ''; }

    // vérifie si l'email est admin (insensible à la casse)
    async function checkAdminsAndUpdateUI(userEmail){
      try{
        const docRef = db.collection('meta').doc('admins');
        const snap = await docRef.get();
        if(!snap.exists) {
          // si pas de doc, create only if email is the initial kenzo -> handled elsewhere
          hideAdminButton();
          return;
        }
        const admins = snap.data().emails || [];
        const adminsLower = admins.map(a => (a||'').toLowerCase());
        if(userEmail && adminsLower.includes(userEmail.toLowerCase())) showAdminButton();
        else hideAdminButton();
      }catch(err){
        console.warn('Erreur checkAdmins:', err);
        hideAdminButton();
      }
    }

    // attend auth state
    auth.onAuthStateChanged(async (user) => {
      if(user){
        // show pseudo/email
        let pseudo = null;
        try{
          const docRef = db.collection('users').doc(user.uid);
          const docSnap = await docRef.get();
          if(docSnap.exists){ const d = docSnap.data(); if(d && d.pseudo) pseudo = d.pseudo; }
        }catch(e){ console.warn('err users read', e); }

        const shown = pseudo || user.displayName || (user.email ? user.email.split('@')[0] : 'Utilisateur');
        pseudoWrap.textContent = shown; pseudoWrap.style.display = 'block';
        emailWrap.textContent = user.email || ''; emailWrap.style.display = user.email ? 'block' : 'none';

        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';

        // ensure initial doc if needed & check admin
        const admins = await ensureInitialAdminsDoc(user.email || '');
        // if we created the doc above, ensureInitialAdminsDoc returned it; otherwise we fetch proper list below
        await checkAdminsAndUpdateUI(user.email || '');
      } else {
        // not connected
        pseudoWrap.style.display = 'none';
        emailWrap.style.display = 'none';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        hideAdminButton();
      }
    });
  </script>
</body>
</html>
