<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Salhi Shop</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, deleteDoc, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyByfz30HgKDfynhOXb24hSOReTJOfk77mI",
  authDomain: "salhishop-1.firebaseapp.com",
  projectId: "salhishop-1",
  storageBucket: "salhishop-1.appspot.com",
  messagingSenderId: "784629559774",
  appId: "1:784629559774:web:388f9ca4c33e90d6fcad4f",
  measurementId: "G-34G9453E7H"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const usersList = document.getElementById('usersList');
const search = document.getElementById('search');
const addAdminBtn = document.getElementById('addAdminBtn');

async function loadUsers() {
  usersList.innerHTML = '';
  const snapshot = await getDocs(collection(db, 'users'));
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const uid = docSnap.id;
    const div = document.createElement('div');
    div.style.marginBottom = '10px';
    div.innerHTML = `
      <span>${data.pseudo} (${data.email})</span>
      <button onclick="editPseudo('${uid}')">Modifier pseudo</button>
      <button onclick="deleteUser('${uid}')">Supprimer</button>
    `;
    usersList.appendChild(div);
  });
}

async function editPseudo(uid) {
  const newPseudo = prompt("Nouveau pseudo :");
  if (!newPseudo) return;
  await updateDoc(doc(db, 'users', uid), { pseudo: newPseudo });
  loadUsers();
}

async function deleteUser(uid) {
  if (!confirm("Supprimer ce compte ?")) return;
  await deleteDoc(doc(db, 'users', uid));
  loadUsers();
}

addAdminBtn.addEventListener('click', async () => {
  const email = prompt("Email du nouvel admin :");
  if (!email) return;
  const adminDoc = doc(db, 'meta', 'admins');
  const docSnap = await getDoc(adminDoc);
  const emails = docSnap.exists() ? docSnap.data().emails : [];
  emails.push(email);
  await setDoc(adminDoc, { emails });
  alert("Admin ajoutÃ© !");
});

search.addEventListener('input', async () => {
  const value = search.value.toLowerCase();
  usersList.innerHTML = '';
  const snapshot = await getDocs(collection(db, 'users'));
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    if (data.pseudo.toLowerCase().includes(value) || data.email.toLowerCase().includes(value)) {
      const uid = docSnap.id;
      const div = document.createElement('div');
      div.style.marginBottom = '10px';
      div.innerHTML = `
        <span>${data.pseudo} (${data.email})</span>
        <button onclick="editPseudo('${uid}')">Modifier pseudo</button>
        <button onclick="deleteUser('${uid}')">Supprimer</button>
      `;
      usersList.appendChild(div);
    }
  });
});

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }
  const adminDoc = await getDoc(doc(db, "meta", "admins"));
  if (!adminDoc.exists() || !adminDoc.data().emails.includes(user.email)) {
    window.location.href = "index.html";
    return;
  }
  loadUsers();
});
</script>
</head>
<body style="font-family:Arial,sans-serif;padding:20px;">
<h1>Admin Panel</h1>
<input type="text" id="search" placeholder="Rechercher un compte..." style="padding:5px;margin-bottom:10px;">
<button id="addAdminBtn">Ajouter Admin</button>
<div id="usersList" style="margin-top:20px;"></div>
</body>
</html>
