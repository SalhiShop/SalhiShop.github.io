<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Salhi Shop</title>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body style="margin:0;font-family:Arial,sans-serif;background:#f0f4f8;">

  <header style="display:flex;justify-content:space-between;align-items:center;background:#00bcd4;padding:10px 20px;color:white;">
    <h1 style="margin:0;font-size:22px;">Admin - Salhi Shop</h1>
    <button onclick="window.location.href='index.html'" style="background:white;color:#00bcd4;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,0.3);">
      Retour
    </button>
  </header>

  <main style="padding:20px;">
    <h2 style="color:#00bcd4;">Gestion des utilisateurs</h2>
    <div id="usersContainer" style="background:white;padding:15px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.2);margin-bottom:20px;"></div>

    <h2 style="color:#00bcd4;">Gestion des admins</h2>
    <div id="adminsContainer" style="background:white;padding:15px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.2);">
      <button id="addAdminBtn" style="padding:8px 12px;border:none;border-radius:5px;background:#00bcd4;color:white;cursor:pointer;">
        ‚ûï Ajouter un admin
      </button>
    </div>
  </main>

  <!-- === SCRIPT PRINCIPAL FIREBASE + EMAILJS === -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, updateDoc, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyByfz30HgKDfynhOXb24hSOReTJOfk77mI",
      authDomain: "salhishop-1.firebaseapp.com",
      projectId: "salhishop-1",
      storageBucket: "salhishop-1.firebasestorage.app",
      messagingSenderId: "784629559774",
      appId: "1:784629559774:web:388f9ca4c33e90d6fcad4f",
      measurementId: "G-34G9453E7H"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Initialisation EmailJS (cl√© publique) ---
    (function() {
      emailjs.init("foHh6pzezeY7gN_hC"); // ‚ö° Cl√© publique
    })();

    // --- V√©rification admin ---
    async function checkIfAdmin(user) {
      const adminsRef = collection(db, "admins");
      const adminsSnap = await getDocs(adminsRef);
      const adminEmails = adminsSnap.docs.map(doc => doc.id);
      return adminEmails.includes(user.email);
    }

    // --- Affichage utilisateurs ---
    async function loadUsers() {
      const usersRef = collection(db, "users");
      const usersSnap = await getDocs(usersRef);
      const container = document.getElementById("usersContainer");
      container.innerHTML = "";

      usersSnap.forEach((userDoc) => {
        const data = userDoc.data();
        const div = document.createElement("div");
        div.style = "display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ddd;padding:6px 0;";

        div.innerHTML = `
          <div>
            <strong>${data.pseudo || "(Sans pseudo)"}</strong><br>
            <small>${data.email || "??"}</small>
          </div>
          <div style="display:flex;gap:6px;">
            <button class="edit-btn" data-id="${userDoc.id}" style="background:#00796b;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">‚úèÔ∏è</button>
            <button class="delete-btn" data-id="${userDoc.id}" style="background:#b71c1c;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">üóëÔ∏è</button>
          </div>
        `;

        container.appendChild(div);
      });

      // gestion √©dition
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const uid = btn.dataset.id;
          const newPseudo = prompt("Nouveau pseudo :");
          if (newPseudo) {
            await updateDoc(doc(db, "users", uid), { pseudo: newPseudo });
            loadUsers();
          }
        });
      });

      // gestion suppression
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const uid = btn.dataset.id;
          if (confirm("Supprimer ce compte ?")) {
            await deleteDoc(doc(db, "users", uid));
            loadUsers();
          }
        });
      });
    }

    // --- Ajouter un admin ---
    document.getElementById("addAdminBtn").addEventListener("click", async () => {
      const email = prompt("Email de l'admin √† ajouter :");
      if (!email) return;
      await setDoc(doc(db, "admins", email), { createdAt: new Date() });
      alert("Admin ajout√© : " + email);
    });

    // --- V√©rifier connexion ---
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      const isAdmin = await checkIfAdmin(user);
      if (!isAdmin) {
        alert("Acc√®s refus√© : pas admin");
        window.location.href = "index.html";
        return;
      }
      loadUsers();
    });
  </script>

  <!-- === SCRIPT TEST ENVOI EMAIL === -->
  <script>
    // Ajoute le bouton test email
    const testBtnContainer = document.createElement("div");
    testBtnContainer.style = "margin-top:15px;";
    testBtnContainer.innerHTML = `
      <button id="testEmailBtn" style="padding:8px 12px;border:none;border-radius:5px;background:#006d6f;color:white;cursor:pointer;">
        üìß Tester envoi email
      </button>
      <span style="font-size:12px;color:#555;margin-left:8px;">Envoi via EmailJS avec ton template.</span>
    `;
    document.getElementById("adminsContainer").appendChild(testBtnContainer);

    document.getElementById("testEmailBtn").addEventListener("click", async () => {
      try {
        const toEmail = prompt("Adresse email de test :", "");
        if (!toEmail) return;
        const toName = prompt("Nom du destinataire :", "Client");

        const itemsHtml = `
          <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee">
            <div>Sandwich Jambon √ó 2</div><div>13.00 CHF</div>
          </div>
          <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee">
            <div>Boisson √ó 1</div><div>2.50 CHF</div>
          </div>
        `;

        const params = {
          to_name: toName,
          to_email: toEmail,
          order_id: "TEST-" + Math.random().toString(36).substring(2, 8),
          old_status: "pending",
          new_status: "preparing",
          items_html: itemsHtml,
          items_text: "- Sandwich Jambon √ó 2 ‚Üí 13.00 CHF\n- Boisson √ó 1 ‚Üí 2.50 CHF",
          subtotal: "15.50",
          shipment: "3.00",
          total: "18.50",
          comment: "Ceci est un test EmailJS",
          order_url: window.location.origin + "/log.html#TEST"
        };

        const res = await emailjs.send("service_y2p5qvk", "template_xxx", params);
        console.log("EmailJS result:", res);
        alert("‚úÖ Email de test envoy√©. V√©rifie la bo√Æte du destinataire !");
      } catch (err) {
        console.error("Erreur EmailJS:", err);
        alert("Erreur envoi email : " + err.message);
      }
    });
  </script>
</body>
</html>
